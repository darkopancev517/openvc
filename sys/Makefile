include module.mk

ifeq ($(MODULE_XTIMER),1)
SRCS_SYS_XTIMER += $(wildcard xtimer/*.c)
OBJS_SYS_XTIMER += $(addprefix $(BUILD)/,$(SRCS_SYS_XTIMER:.c=.o))
OBJS_DIR += $(sort $(dir $(OBJS_SYS_XTIMER)))
LIB_SYS_XTIMER_ARCHIVE = $(BUILD)/$(LIB_SYS_XTIMER)
LIB_SYS_XTIMER_OBJS += $(OBJS_SYS_XTIMER)
ARCHIVE_FILES += $(LIB_SYS_XTIMER_ARCHIVE)
endif

ifeq ($(MODULE_DIV),1)
SRCS_SYS_DIV += $(wildcard div/*.c)
OBJS_SYS_DIV += $(addprefix $(BUILD)/,$(SRCS_SYS_DIV:.c=.o))
OBJS_DIR += $(sort $(dir $(OBJS_SYS_DIV)))
LIB_SYS_DIV_ARCHIVE = $(BUILD)/$(LIB_SYS_DIV)
LIB_SYS_DIV_OBJS += $(OBJS_SYS_DIV)
ARCHIVE_FILES += $(LIB_SYS_DIV_ARCHIVE)
endif

ifeq ($(MODULE_TIMEX),1)
SRCS_SYS_TIMEX += $(wildcard timex/*.c)
OBJS_SYS_TIMEX += $(addprefix $(BUILD)/,$(SRCS_SYS_TIMEX:.c=.o))
OBJS_DIR += $(sort $(dir $(OBJS_SYS_TIMEX)))
LIB_SYS_TIMEX_ARCHIVE = $(BUILD)/$(LIB_SYS_TIMEX)
LIB_SYS_TIMEX_OBJS += $(OBJS_SYS_TIMEX)
ARCHIVE_FILES += $(LIB_SYS_TIMEX_ARCHIVE)
endif

ifeq ($(MODULE_ISRPIPE),1)
SRCS_SYS_ISRPIPE += $(wildcard isrpipe/*.c)
OBJS_SYS_ISRPIPE += $(addprefix $(BUILD)/,$(SRCS_SYS_ISRPIPE:.c=.o))
OBJS_DIR += $(sort $(dir $(OBJS_SYS_ISRPIPE)))
LIB_SYS_ISRPIPE_ARCHIVE = $(BUILD)/$(LIB_SYS_ISRPIPE)
LIB_SYS_ISRPIPE_OBJS += $(OBJS_SYS_ISRPIPE)
ARCHIVE_FILES += $(LIB_SYS_ISRPIPE_ARCHIVE)
endif

ifeq ($(MODULE_STDIO_UART),1)
SRCS_SYS_STDIO_UART += $(wildcard stdio_uart/*.c)
OBJS_SYS_STDIO_UART += $(addprefix $(BUILD)/,$(SRCS_SYS_STDIO_UART:.c=.o))
OBJS_DIR += $(sort $(dir $(OBJS_SYS_STDIO_UART)))
LIB_SYS_STDIO_UART_ARCHIVE = $(BUILD)/$(LIB_SYS_STDIO_UART)
LIB_SYS_STDIO_UART_OBJS += $(OBJS_SYS_STDIO_UART)
ARCHIVE_FILES += $(LIB_SYS_STDIO_UART_ARCHIVE)
endif

ifeq ($(MODULE_SYSCALLS),1)
SRCS_SYS_SYSCALLS += $(wildcard syscalls/*.c)
OBJS_SYS_SYSCALLS += $(addprefix $(BUILD)/,$(SRCS_SYS_SYSCALLS:.c=.o))
OBJS_DIR += $(sort $(dir $(OBJS_SYS_SYSCALLS)))
LIB_SYS_SYSCALLS_ARCHIVE = $(BUILD)/$(LIB_SYS_SYSCALLS)
LIB_SYS_SYSCALLS_OBJS += $(OBJS_SYS_SYSCALLS)
ARCHIVE_FILES += $(LIB_SYS_SYSCALLS_ARCHIVE)
endif

ifeq ($(MODULE_TSRB),1)
SRCS_SYS_TSRB += $(wildcard tsrb/*.c)
OBJS_SYS_TSRB += $(addprefix $(BUILD)/,$(SRCS_SYS_TSRB:.c=.o))
OBJS_DIR += $(sort $(dir $(OBJS_SYS_TSRB)))
LIB_SYS_TSRB_ARCHIVE = $(BUILD)/$(LIB_SYS_TSRB)
LIB_SYS_TSRB_OBJS += $(OBJS_SYS_TSRB)
ARCHIVE_FILES += $(LIB_SYS_TSRB_ARCHIVE)
endif

ifeq ($(MODULE_SHELL),1)
SRCS_SYS_SHELL += $(wildcard shell/*.c)
SRCS_SYS_SHELL_COMMANDS += shell/commands/shell_commands.c
SRCS_SYS_SHELL_COMMANDS += shell/commands/cmd_mem.c
SRCS_SYS_SHELL_COMMANDS += shell/commands/cmd_reboot.c
ifeq ($(MODULE_PS),1)
SRCS_SYS_SHELL_COMMANDS += shell/commands/cmd_ps.c
endif
ifeq ($(MODULE_DRIVERS_CENTAURI),1)
SRCS_SYS_SHELL_COMMANDS += shell/commands/cmd_cent.c
endif
OBJS_SYS_SHELL += $(addprefix $(BUILD)/,$(SRCS_SYS_SHELL:.c=.o))
OBJS_SYS_SHELL_COMMANDS += $(addprefix $(BUILD)/,$(SRCS_SYS_SHELL_COMMANDS:.c=.o))
OBJS_DIR += $(sort $(dir $(OBJS_SYS_SHELL)))
OBJS_DIR += $(sort $(dir $(OBJS_SYS_SHELL_COMMANDS)))
LIB_SYS_SHELL_ARCHIVE = $(BUILD)/$(LIB_SYS_SHELL)
LIB_SYS_SHELL_OBJS += $(OBJS_SYS_SHELL)
LIB_SYS_SHELL_COMMANDS_ARCHIVE = $(BUILD)/$(LIB_SYS_SHELL_COMMANDS)
LIB_SYS_SHELL_COMMANDS_OBJS += $(OBJS_SYS_SHELL_COMMANDS)
ARCHIVE_FILES += $(LIB_SYS_SHELL_ARCHIVE)
ARCHIVE_FILES += $(LIB_SYS_SHELL_COMMANDS_ARCHIVE)
endif

ifeq ($(MODULE_PS),1)
SRCS_SYS_PS += $(wildcard ps/*.c)
OBJS_SYS_PS += $(addprefix $(BUILD)/,$(SRCS_SYS_PS:.c=.o))
OBJS_DIR += $(sort $(dir $(OBJS_SYS_PS)))
LIB_SYS_PS_ARCHIVE = $(BUILD)/$(LIB_SYS_PS)
LIB_SYS_PS_OBJS += $(OBJS_SYS_PS)
ARCHIVE_FILES += $(LIB_SYS_PS_ARCHIVE)
endif

ifeq ($(MODULE_AUTO_INIT),1)
SRCS_SYS_AUTO_INIT += $(wildcard auto_init/*.c)
OBJS_SYS_AUTO_INIT += $(addprefix $(BUILD)/,$(SRCS_SYS_AUTO_INIT:.c=.o))
OBJS_DIR += $(sort $(dir $(OBJS_SYS_AUTO_INIT)))
LIB_SYS_AUTO_INIT_ARCHIVE = $(BUILD)/$(LIB_SYS_AUTO_INIT)
LIB_SYS_AUTO_INIT_OBJS += $(OBJS_SYS_AUTO_INIT)
ARCHIVE_FILES += $(LIB_SYS_AUTO_INIT_ARCHIVE)
endif

all: | $(OBJS_DIR) $(ARCHIVE_FILES)
$(OBJS_DIR):
	$(MKDIR) -p $@

$(BUILD)/%.o: %.c
	$(ECHO) "CC $<"
	$(CC) -DFILE_RELATIVE=\"$(patsubst $(TOP)/%,%,$(abspath $<))\" \
		  -DFILE_NOPATH=\"$(notdir $<)\" \
		  $(CFLAGS) -c -o $@ $<

$(BUILD)/%.a:
	$(ECHO) "AR $@"
	$(AR) -cr $@ $^

$(LIB_SYS_XTIMER_ARCHIVE): $(LIB_SYS_XTIMER_OBJS)

$(LIB_SYS_DIV_ARCHIVE): $(LIB_SYS_DIV_OBJS)

$(LIB_SYS_TIMEX_ARCHIVE): $(LIB_SYS_TIMEX_OBJS)

$(LIB_SYS_ISRPIPE_ARCHIVE): $(LIB_SYS_ISRPIPE_OBJS)

$(LIB_SYS_STDIO_UART_ARCHIVE): $(LIB_SYS_STDIO_UART_OBJS)

$(LIB_SYS_SYSCALLS_ARCHIVE): $(LIB_SYS_SYSCALLS_OBJS)

$(LIB_SYS_TSRB_ARCHIVE): $(LIB_SYS_TSRB_OBJS)

$(LIB_SYS_SHELL_ARCHIVE): $(LIB_SYS_SHELL_OBJS)

$(LIB_SYS_SHELL_COMMANDS_ARCHIVE): $(LIB_SYS_SHELL_COMMANDS_OBJS)

$(LIB_SYS_PS_ARCHIVE): $(LIB_SYS_PS_OBJS)

$(LIB_SYS_AUTO_INIT_ARCHIVE): $(LIB_SYS_AUTO_INIT_OBJS)

-include $(OBJS_SYS_XTIMER:%.o=%.d)
-include $(OBJS_SYS_DIV:%.o=%.d)
-include $(OBJS_SYS_TIMEX:%.o=%.d)
-include $(OBJS_SYS_ISRPIPE:%.o=%.d)
-include $(OBJS_SYS_STDIO_UART:%.o=%.d)
-include $(OBJS_SYS_SYSCALLS:%.o=%.d)
-include $(OBJS_SYS_TSRB:%.o=%.d)
-include $(OBJS_SYS_SHELL:%.o=%.d)
-include $(OBJS_SYS_SHELL_COMMANDS:%.o=%.d)
-include $(OBJS_SYS_PS:%.o=%.d)
-include $(OBJS_SYS_AUTO_INIT:%.o=%.d)

SRCS_SYS_ISRPIPE += $(wildcard isrpipe/*.c)
SRCS_SYS_STDIO_UART += $(wildcard stdio_uart/*.c)
SRCS_SYS_SYSCALLS += $(wildcard syscalls/*.c)
SRCS_SYS_TSRB += $(wildcard tsrb/*.c)
SRCS_SYS_SHELL += $(wildcard shell/*.c)
SRCS_SYS_SHELL_COMMANDS += $(wildcard shell/commands/*.c)
SRCS_SYS_PS += $(wildcard ps/*.c)

OBJS_SYS_ISRPIPE += $(addprefix $(BUILD)/, $(SRCS_SYS_ISRPIPE:.c=.o))
OBJS_SYS_STDIO_UART += $(addprefix $(BUILD)/, $(SRCS_SYS_STDIO_UART:.c=.o))
OBJS_SYS_SYSCALLS += $(addprefix $(BUILD)/, $(SRCS_SYS_SYSCALLS:.c=.o))
OBJS_SYS_TSRB += $(addprefix $(BUILD)/, $(SRCS_SYS_TSRB:.c=.o))
OBJS_SYS_SHELL += $(addprefix $(BUILD)/, $(SRCS_SYS_SHELL:.c=.o))
OBJS_SYS_SHELL_COMMANDS += $(addprefix $(BUILD)/, $(SRCS_SYS_SHELL_COMMANDS:.c=.o))
OBJS_SYS_PS += $(addprefix $(BUILD)/, $(SRCS_SYS_PS:.c=.o))

OBJS_DIR += $(sort $(dir $(OBJS_SYS_ISRPIPE)))
OBJS_DIR += $(sort $(dir $(OBJS_SYS_STDIO_UART)))
OBJS_DIR += $(sort $(dir $(OBJS_SYS_SYSCALLS)))
OBJS_DIR += $(sort $(dir $(OBJS_SYS_TSRB)))
OBJS_DIR += $(sort $(dir $(OBJS_SYS_SHELL)))
OBJS_DIR += $(sort $(dir $(OBJS_SYS_SHELL_COMMANDS)))
OBJS_DIR += $(sort $(dir $(OBJS_SYS_PS)))

LIB_SYS_ISRPIPE_ARCHIVE = $(BUILD)/$(LIB_SYS_ISRPIPE)
LIB_SYS_ISRPIPE_OBJS += $(OBJS_SYS_ISRPIPE)

LIB_SYS_STDIO_UART_ARCHIVE = $(BUILD)/$(LIB_SYS_STDIO_UART)
LIB_SYS_STDIO_UART_OBJS += $(OBJS_SYS_STDIO_UART)

LIB_SYS_SYSCALLS_ARCHIVE = $(BUILD)/$(LIB_SYS_SYSCALLS)
LIB_SYS_SYSCALLS_OBJS += $(OBJS_SYS_SYSCALLS)

LIB_SYS_TSRB_ARCHIVE = $(BUILD)/$(LIB_SYS_TSRB)
LIB_SYS_TSRB_OBJS += $(OBJS_SYS_TSRB)

LIB_SYS_SHELL_ARCHIVE = $(BUILD)/$(LIB_SYS_SHELL)
LIB_SYS_SHELL_OBJS += $(OBJS_SYS_SHELL)

LIB_SYS_SHELL_COMMANDS_ARCHIVE = $(BUILD)/$(LIB_SYS_SHELL_COMMANDS)
LIB_SYS_SHELL_COMMANDS_OBJS += $(OBJS_SYS_SHELL_COMMANDS)

LIB_SYS_PS_ARCHIVE = $(BUILD)/$(LIB_SYS_PS)
LIB_SYS_PS_OBJS += $(OBJS_SYS_PS)

ARCHIVE_FILES += $(LIB_SYS_ISRPIPE_ARCHIVE)
ARCHIVE_FILES += $(LIB_SYS_STDIO_UART_ARCHIVE)
ARCHIVE_FILES += $(LIB_SYS_SYSCALLS_ARCHIVE)
ARCHIVE_FILES += $(LIB_SYS_TSRB_ARCHIVE)
ARCHIVE_FILES += $(LIB_SYS_SHELL_ARCHIVE)
ARCHIVE_FILES += $(LIB_SYS_SHELL_COMMANDS_ARCHIVE)
ARCHIVE_FILES += $(LIB_SYS_PS_ARCHIVE)

all: | $(OBJS_DIR) $(ARCHIVE_FILES)
$(OBJS_DIR):
	$(MKDIR) -p $@

$(BUILD)/%.o: %.c
	$(ECHO) "CC $<"
	$(CC) -DFILE_RELATIVE=\"$(patsubst $(TOP)/%,%,$(abspath $<))\" \
		  -DFILE_NOPATH=\"$(notdir $<)\" \
		  $(CFLAGS) -c -o $@ $<

$(BUILD)/%.a:
	$(ECHO) "AR $@"
	$(AR) -cr $@ $^

$(LIB_SYS_ISRPIPE_ARCHIVE): $(LIB_SYS_ISRPIPE_OBJS)

$(LIB_SYS_STDIO_UART_ARCHIVE): $(LIB_SYS_STDIO_UART_OBJS)

$(LIB_SYS_SYSCALLS_ARCHIVE): $(LIB_SYS_SYSCALLS_OBJS)

$(LIB_SYS_TSRB_ARCHIVE): $(LIB_SYS_TSRB_OBJS)

$(LIB_SYS_SHELL_ARCHIVE): $(LIB_SYS_SHELL_OBJS)

$(LIB_SYS_SHELL_COMMANDS_ARCHIVE): $(LIB_SYS_SHELL_COMMANDS_OBJS)

$(LIB_SYS_PS_ARCHIVE): $(LIB_SYS_PS_OBJS)

-include $(OBJS_SYS_ISRPIPE:%.o=%.d)
-include $(OBJS_SYS_STDIO_UART:%.o=%.d)
-include $(OBJS_SYS_SYSCALLS:%.o=%.d)
-include $(OBJS_SYS_TSRB:%.o=%.d)
-include $(OBJS_SYS_SHELL:%.o=%.d)
-include $(OBJS_SYS_SHELL_COMMANDS:%.o=%.d)
-include $(OBJS_SYS_PS:%.o=%.d)
